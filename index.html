<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>UV-Touch Music</title>
  <link rel="stylesheet" href="css/reset.min.css">
</head>
<body onload='init();'>
  <div id="view"></div>
  <script src="js/jquery.min.js"></script>
  <script src="js/pixi.min.js"></script>
  <script src="js/pixi-sound.js"></script>
	<script src="js/TweenMax.min.js"></script>
  <script>
  function init(){
    var app = new PIXI.Application(640,1030);
    $('#view').append(app.view);

    $('#view,canvas').css({
      'position':'absolute',
      'width':'100%',
      'height':'100%',
      'top':'0px',
      'left':'0px'
    });

    var loader = new PIXI.loaders.Loader();
    loader.add(['js/main.json','sounds/bg.mp3','images/info.png','images/copyright.png','images/title.png','images/start.png']);
    loader.on('progress',function (load,res){
    });
    loader.load(bg);

    class centerImg extends PIXI.Sprite{
      constructor(x,y,img){
        super();
        this.texture = PIXI.Texture.fromImage(img);
        this.anchor.set(0.5);
        this.x = x;
        this.y = y;
      }
    }


    var ani = new PIXI.Graphics();

    function mkAni1(obj){


      ani.clear();
    ani.beginFill(Math.random()*0xffffff)
    .moveTo(obj.x,obj.y)
    .lineTo(0,0)
    .lineTo(320,0)
    .closePath()

    ani.beginFill(Math.random()*0xffffff)
    .moveTo(obj.x,obj.y)
    .lineTo(320,0)
    .lineTo(640,0)
    .closePath()

    ani.beginFill(Math.random()*0xffffff)
    .moveTo(obj.x,obj.y)
    .lineTo(0,1030)
    .lineTo(320,1030)
    .closePath()

    ani.beginFill(Math.random()*0xffffff)
    .moveTo(obj.x,obj.y)
    .lineTo(320,1030)
    .lineTo(640,1030)
    .closePath()

    ani.beginFill(Math.random()*0xffffff)
    .moveTo(obj.x,obj.y)
    .lineTo(0,0)
    .lineTo(0,1030/2)
    .closePath()

    ani.beginFill(Math.random()*0xffffff)
    .moveTo(obj.x,obj.y)
    .lineTo(0,1030/2)
    .lineTo(0,1030)
    .closePath()

    ani.beginFill(Math.random()*0xffffff)
    .moveTo(obj.x,obj.y)
    .lineTo(640,0)
    .lineTo(640,1030/2)
    .closePath()

    ani.beginFill(Math.random()*0xffffff)
    .moveTo(obj.x,obj.y)
    .lineTo(640,1030/2)
    .lineTo(640,1030)
    .closePath()

    app.stage.addChild(ani);
    };

    function mkAni2(){
    ani.beginFill(Math.random()*0xffffff)
    .lineTo(Math.random()*640,Math.random()*1030)
    .lineTo(Math.random()*640,Math.random()*1030)
    .lineTo(Math.random()*640,Math.random()*1030)
    app.stage.addChild(ani);
    };

    class grid extends PIXI.Graphics{
      constructor(x,y,w,h,mainMusic){
        super();
        this.beginFill(0xfff1e00).drawRect(0,0,w,h);
        this.x = x;
        this.y = y;
        this.interactive = true;
        this.on('touchstart',function (event){
          this.ani(event);
          this.sound(mainMusic);
        });
        app.stage.addChild(this);
      }
      ani(event){
        console.log(1);
        mkAni1(event.data.global);
      }
      sound(mainMusic){
        let music = new PIXI.sound.Sound.from({
          url:mainMusic[Math.floor(Math.random()*31) + '.mp3'],
          autoPlay:true
        })
      }
    }

    function bg(){
      let bg = new PIXI.Graphics();
      bg.beginFill(Math.random()*0xffffff).drawRect(0,0,640,1030);
      app.stage.addChildAt(bg,0);
      cover();
    }

    function cover(){       //封面
      var cover = new PIXI.Container();
      app.stage.addChild(cover);
      var title = new centerImg(320,200,'images/title.png');
      var start = new centerImg(320,500,'images/start.png');
      var copyRight = new centerImg(320,900,'images/copyright.png');
      cover.addChild(title,start,copyRight);

      new TweenMax(start.scale,1,{
        x:3,
        y:3,
        yoyo:true,
        repeat:-1
      })

      start.interactive = true;
      start.on('pointertap',function (){
        cover.destroy();
        gotoPlay();
      });
    }

    function gotoPlay(){
      var mainMusic = {};
      $.get('js/main.json',function (data,status){
        if(status == 'success'){
          mainMusic = data;
          drawGrid();
        }else{
          console.error(status)
        }
      });

      function drawGrid(){
        var grids = [];

        for(let x = 0;x<4;x++){
          for(let y = 0; y<8;y++ ){
            grids.push(
              new grid(x*(640/4),y*(1030/8),640/4,1030/8,mainMusic)
            );
          }
        }

        console.log(grids);

      };

    };





  };
  </script>
</body>
</html>
